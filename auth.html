<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>URSA Auth Safe</title>
  <style>
    body {
      background:#000;
      color:#0ff;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      height:100vh;
      font-family:-apple-system, BlinkMacSystemFont, "SF Pro Text";
      text-align:center;
    }
    button {
      background:#0ff;
      color:#000;
      border:none;
      border-radius:12px;
      padding:12px 26px;
      font-size:17px;
      font-weight:600;
      margin-top:22px;
      transition:opacity 0.25s;
    }
    button:active { opacity:0.7; }
    #status { opacity:0.85; font-size:15px; max-width:90%; }
  </style>
</head>
<body>
  <div id="status">üîê –ì–æ—Ç–æ–≤–æ –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏</div>
  <button id="go">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>

  <script type="module">
    import { auth } from "./assets/js/firebase.js";
    import {
      GoogleAuthProvider,
      signInWithRedirect,
      signInWithPopup,
      getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const status = (msg) => document.getElementById("status").innerText = msg;
    const goBtn = document.getElementById("go");

    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // === –ü—Ä–æ–≤–µ—Ä—è–µ–º –≤–æ–∑–≤—Ä–∞—Ç –ø–æ—Å–ª–µ redirect ===
    (async () => {
      const res = await getRedirectResult(auth);
      if (res?.user) {
        const token = await res.user.getIdToken();
        status("‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ —á–µ—Ä–µ–∑ redirect! –û—Ç–∫—Ä—ã–≤–∞–µ–º URSA...");
        setTimeout(() => window.open("https://ursaipa.live/?token=" + encodeURIComponent(token), "_blank"), 700);
      }
    })();

    // === –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –Ω–∞–∂–∞—Ç–∏—è –∫–Ω–æ–ø–∫–∏ ===
    goBtn.onclick = async () => {
      try {
        status("üåê –ü—ã—Ç–∞–µ–º—Å—è –æ—Ç–∫—Ä—ã—Ç—å Google popup...");
        // –ü–æ–ø—Ä–æ–±—É–µ–º popup ‚Äî Safari —Ä–∞–∑—Ä–µ—à–∏—Ç, —Ç.–∫. —ç—Ç–æ –ø–æ –∫–ª–∏–∫—É
        const res = await signInWithPopup(auth, provider);
        if (res?.user) {
          const token = await res.user.getIdToken();
          status("‚úÖ Popup-–≤—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –û—Ç–∫—Ä—ã–≤–∞–µ–º URSA...");
          setTimeout(() => window.open("https://ursaipa.live/?token=" + encodeURIComponent(token), "_blank"), 700);
          return;
        }
      } catch (e) {
        console.warn("‚ö†Ô∏è Popup –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª, –ø—Ä–æ–±—É–µ–º redirect:", e);
        status("‚Ü™Ô∏è Popup –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω Safari. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...");
        await signInWithRedirect(auth, provider);
      }
    };
  </script>
</body>
</html>
