<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>URSA Auth Safe Reopen</title>
  <style>
    body {
      background:#000;
      color:#0ff;
      display:flex;
      align-items:center;
      justify-content:center;
      flex-direction:column;
      height:100vh;
      font-family:-apple-system,BlinkMacSystemFont,"SF Pro Text";
      text-align:center;
      font-size:16px;
    }
    #status { opacity:0.9; margin-bottom:24px; max-width:90%; }
    button {
      background:#0ff;
      color:#000;
      border:none;
      border-radius:12px;
      padding:12px 28px;
      font-size:17px;
      font-weight:600;
      transition:opacity 0.25s;
    }
    button:active { opacity:0.7; }
  </style>
</head>
<body>
  <div id="status">üîê –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏...</div>
  <button id="go">–í–æ–π—Ç–∏ —á–µ—Ä–µ–∑ Google</button>
  <button id="open" style="display:none;">–û—Ç–∫—Ä—ã—Ç—å URSA –≤—Ä—É—á–Ω—É—é</button>

  <script type="module">
    import { auth } from "./assets/js/firebase.js";
    import {
      GoogleAuthProvider,
      signInWithRedirect,
      signInWithPopup,
      getRedirectResult
    } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";

    const status = (msg) => document.getElementById("status").innerText = msg;
    const goBtn = document.getElementById("go");
    const openBtn = document.getElementById("open");
    const provider = new GoogleAuthProvider();
    provider.setCustomParameters({ prompt: "select_account" });

    // === –ü–æ—Å–ª–µ redirect ===
    (async () => {
      const res = await getRedirectResult(auth);
      if (res?.user) {
        const token = await res.user.getIdToken();
        status("‚úÖ Redirect-–≤—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –ü–µ—Ä–µ—Ö–æ–¥–∏–º –≤ URSA...");
        try {
          const w = window.open("https://ursaipa.live/?token=" + encodeURIComponent(token), "_blank");
          if (!w) {
            // Safari –±–ª–æ–∫–Ω—É–ª popup ‚Üí –ø–æ–∫–∞–∑–∞—Ç—å –∫–Ω–æ–ø–∫—É –≤—Ä—É—á–Ω—É—é
            status("‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω! Safari –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –ø–µ—Ä–µ—Ö–æ–¥.");
            openBtn.style.display = "block";
            openBtn.onclick = () => window.location.href = "https://ursaipa.live/?token=" + encodeURIComponent(token);
          }
        } catch {
          openBtn.style.display = "block";
          openBtn.onclick = () => window.location.href = "https://ursaipa.live/?token=" + encodeURIComponent(token);
        }
        return;
      }
    })();

    // === –û—Å–Ω–æ–≤–Ω–æ–π –≤—Ö–æ–¥ –ø–æ –∫–ª–∏–∫—É ===
    goBtn.onclick = async () => {
      try {
        status("üåê –û—Ç–∫—Ä—ã–≤–∞–µ–º Google popup...");
        const res = await signInWithPopup(auth, provider);
        if (res?.user) {
          const token = await res.user.getIdToken();
          status("‚úÖ –ü–æ–ø-–∞–ø –≤—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω! –û—Ç–∫—Ä—ã–≤–∞–µ–º URSA...");
          try {
            const w = window.open("https://ursaipa.live/?token=" + encodeURIComponent(token), "_blank");
            if (!w) {
              // Safari –∑–∞–ø—Ä–µ—Ç–∏–ª
              status("‚úÖ –í—Ö–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω! Safari –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–ª –æ—Ç–∫—Ä—ã—Ç–∏–µ URSA.");
              openBtn.style.display = "block";
              openBtn.onclick = () => window.location.href = "https://ursaipa.live/?token=" + encodeURIComponent(token);
            }
          } catch {
            openBtn.style.display = "block";
            openBtn.onclick = () => window.location.href = "https://ursaipa.live/?token=" + encodeURIComponent(token);
          }
        } else {
          throw new Error("Popup –Ω–µ –≤–µ—Ä–Ω—É–ª –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è");
        }
      } catch (e) {
        console.warn("Popup –≤—Ö–æ–¥ –Ω–µ —Å—Ä–∞–±–æ—Ç–∞–ª:", e);
        status("‚Ü™Ô∏è Popup –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω Safari. –ü–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ–º...");
        await signInWithRedirect(auth, provider);
      }
    };
  </script>
</body>
</html>
